"use strict";(self.webpackChunkthelia=self.webpackChunkthelia||[]).push([[3036],{3905:function(e,t,n){n.d(t,{Zo:function(){return m},kt:function(){return p}});var a=n(7294);function l(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){l(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function r(e,t){if(null==e)return{};var n,a,l=function(e,t){if(null==e)return{};var n,a,l={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(l[n]=e[n]);return l}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(l[n]=e[n])}return l}var s=a.createContext({}),d=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},m=function(e){var t=d(e.components);return a.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},c=a.forwardRef((function(e,t){var n=e.components,l=e.mdxType,i=e.originalType,s=e.parentName,m=r(e,["components","mdxType","originalType","parentName"]),c=d(n),p=l,h=c["".concat(s,".").concat(p)]||c[p]||u[p]||i;return n?a.createElement(h,o(o({ref:t},m),{},{components:n})):a.createElement(h,o({ref:t},m))}));function p(e,t){var n=arguments,l=t&&t.mdxType;if("string"==typeof e||l){var i=n.length,o=new Array(i);o[0]=c;var r={};for(var s in t)hasOwnProperty.call(t,s)&&(r[s]=t[s]);r.originalType=e,r.mdxType="string"==typeof e?e:l,o[1]=r;for(var d=2;d<i;d++)o[d]=n[d];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}c.displayName="MDXCreateElement"},8976:function(e,t,n){n.r(t),n.d(t,{assets:function(){return m},contentTitle:function(){return s},default:function(){return p},frontMatter:function(){return r},metadata:function(){return d},toc:function(){return u}});var a=n(7462),l=n(3366),i=(n(7294),n(3905)),o=["components"],r={title:"Extending Thelia",sidebar_position:2,toc_max_heading_level:6},s=void 0,d={unversionedId:"getting_started/extending_thelia",id:"getting_started/extending_thelia",title:"Extending Thelia",description:"Create a module",source:"@site/docs/getting_started/extending_thelia.md",sourceDirName:"getting_started",slug:"/getting_started/extending_thelia",permalink:"/docs/docs/getting_started/extending_thelia",draft:!1,editUrl:"https://github.com/thelia/docs/edit/main/docs/getting_started/extending_thelia.md",tags:[],version:"current",sidebarPosition:2,frontMatter:{title:"Extending Thelia",sidebar_position:2,toc_max_heading_level:6},sidebar:"myAutogeneratedSidebar",previous:{title:"Installation",permalink:"/docs/docs/getting_started/Installation"},next:{title:"Update",permalink:"/docs/docs/getting_started/Update"}},m={},u=[{value:"Create a module",id:"create-a-module",level:2},{value:"Base file (MyProject.php)",id:"base-file-myprojectphp",level:2},{value:"Extend the database",id:"extend-the-database",level:2},{value:"Describing schema",id:"describing-schema",level:3},{value:"Add a column to native Thelia table",id:"add-a-column-to-native-thelia-table",level:4},{value:"Generate Sql / Model from schema",id:"generate-sql--model-from-schema",level:3},{value:"Execute Sql",id:"execute-sql",level:3},{value:"At module initialization",id:"at-module-initialization",level:4},{value:"On module update",id:"on-module-update",level:4},{value:"Routing",id:"routing",level:2},{value:"Templating",id:"templating",level:2},{value:"Templates structure",id:"templates-structure",level:3},{value:"Features",id:"features",level:3},{value:"Loops",id:"loops",level:4},{value:"Smarty plugins",id:"smarty-plugins",level:4}],c={toc:u};function p(e){var t=e.components,n=(0,l.Z)(e,o);return(0,i.kt)("wrapper",(0,a.Z)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h2",{id:"create-a-module"},"Create a module"),(0,i.kt)("div",{className:"admonition admonition-caution alert alert--warning"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 16 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"}))),"caution")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"We advise to create only one module for all your own logic, don't create one module by feature or something else.",(0,i.kt)("br",{parentName:"p"}),"\n","The only reason to create a separate module is if you want to share it with the community \ud83d\ude09"))),(0,i.kt)("p",null,"To extend to Thelia you need to create a module in general for the main module we call it with the same name as the project."),(0,i.kt)("p",null,"A command can help you to create the base files :"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"php Thelia module:generate MyProject\n")),(0,i.kt)("p",null,"This will generate this structure in the directory ",(0,i.kt)("inlineCode",{parentName:"p"},"local\\modules")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"\\MyProject\n  MyProject.php <- mandatory\n  composer.json\n  \\Config\n    config.xml   <- mandatory\n    module.xml   <- mandatory\n    routing.xml\n    schema.xml\n  ...\n")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"MyProject.php")," is the base file of your module it will help you to set up some behaviour  "),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"module.xml")," contains information about module like version of the module, compatibility and dependencies with other modules, author, ...    "),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"config.xml")," to declare your services, event listener, loops, forms, commands or hooks. But thanks to symfony autowiring most of the time you won't need to do this."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"routing.xml")," to list your application's routes, like config.xml this file is not very useful anymore because we can put the routes directly in the controllers."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"schema.xml")," to describe the database table related to your module."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"composer.json")," help you to share your module with the community")),(0,i.kt)("p",null,"Once the module is created you can go to your shop back-office and active it in the module list."),(0,i.kt)("h2",{id:"base-file-myprojectphp"},"Base file (MyProject.php)"),(0,i.kt)("p",null,"This file must extend the ",(0,i.kt)("inlineCode",{parentName:"p"},"Thelia\\Module\\BaseModule")," class (except for payments and deliveries modules)\nDuring the lifecycle of a module theses function are called and allow you to apply your own logic by overwritting them :"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"install(ConnectionInterface $con = null);")," This method is called when the plugin is installed for the first time."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"preActivation(ConnectionInterface $con = null);")," This method is called before the module activation, and may prevent it by returning false."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"postActivation(ConnectionInterface $con = null);")," This method is called after was successfully activated."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"preDeactivation(ConnectionInterface $con = null);")," This method is called before the module deactivation, and may prevent it by returning false."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"postDeactivation(ConnectionInterface $con = null);")," This method is called after was successfully deactivated."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"update($currentVersion, $newVersion, ConnectionInterface $con = null);")," This method is called on a module refresh if the previous version in module.xml is different than the current version")),(0,i.kt)("h2",{id:"extend-the-database"},"Extend the database"),(0,i.kt)("h3",{id:"describing-schema"},"Describing schema"),(0,i.kt)("p",null,"To describe your schema please refer to ",(0,i.kt)("a",{parentName:"p",href:"http://propelorm.org/documentation/reference/schema.html"},"propel documentation"),"."),(0,i.kt)("h4",{id:"add-a-column-to-native-thelia-table"},"Add a column to native Thelia table"),(0,i.kt)("p",null,"In Thelia it is ",(0,i.kt)("strong",{parentName:"p"},"not")," possible to modify the native tables.",(0,i.kt)("br",{parentName:"p"}),"\n","The best practice to add columns is to create a new table with a foreign key attached to the base table."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-xml"},'    <table name="extend_customer_data" namespace="MyProject\\Model">\n        <column name="id" primaryKey="true" required="true" type="INTEGER" />\n        <column name="additional_column" type="VARCHAR" size="255" />\n        <foreign-key foreignTable="customer" name="fk_extend_customer_data_customer_id" onDelete="CASCADE" onUpdate="CASCADE">\n            <reference foreign="id" local="id" />\n        </foreign-key>\n        ...\n    </table>\n')),(0,i.kt)("h3",{id:"generate-sql--model-from-schema"},"Generate Sql / Model from schema"),(0,i.kt)("p",null,"To generate Sql request and associated model class from schema use this command"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"php Thelia module:generate:model --generate-sql MyProject \n")),(0,i.kt)("p",null,"This command will generate a TheliaMain.sql file at ",(0,i.kt)("inlineCode",{parentName:"p"},"local/modules/MyProject/Confif/TheliaMain.sql")," don't modify it, it will be erased each time this command is executed.",(0,i.kt)("br",{parentName:"p"}),"\n","It will also generate ",(0,i.kt)("a",{parentName:"p",href:"http://propelorm.org/documentation/reference/active-record.html"},"Model")," and ",(0,i.kt)("a",{parentName:"p",href:"http://propelorm.org/documentation/reference/model-criteria.html"},"ModelQuery")," file for each table, in these files you and add your own function or property, they will not be erased as they are just empty class that extend the real propel Model located in propel cache. "),(0,i.kt)("h3",{id:"execute-sql"},"Execute Sql"),(0,i.kt)("h4",{id:"at-module-initialization"},"At module initialization"),(0,i.kt)("p",null,"If you want to execute the sql at the first module activation add this function to your module's base file :"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-php"},"    public function postActivation(ConnectionInterface $con = null): void\n    {\n        // Look if module has already been activated \n        if (!self::getConfigValue('is_initialized', false)) {\n            $database = new Database($con);\n            // Insert generated file\n            $database->insertSql(null, [__DIR__.'/Config/TheliaMain.sql']);\n            \n            // Set module as initialized\n            self::setConfigValue('is_initialized', true);\n        }\n    }\n")),(0,i.kt)("h4",{id:"on-module-update"},"On module update"),(0,i.kt)("p",null,"If your module has already been activated you must go through the update system.\nFor now there is no way to get directly the sql request needed to update your database, you need to extract it from the generated TheliaMain.sql."),(0,i.kt)("p",null,"For example if at module initialization you have this sql generated :"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sql"},"DROP TABLE IF EXISTS `block_group`;\n\nCREATE TABLE `block_group`\n(\n    `id` INTEGER NOT NULL AUTO_INCREMENT,\n    `slug` VARCHAR(50),\n    `created_at` DATETIME,\n    `updated_at` DATETIME,\n    PRIMARY KEY (`id`),\n    UNIQUE INDEX `slug_unique` (`slug`)\n) ENGINE=InnoDB;\n")),(0,i.kt)("p",null,'And later you want to add a new boolean column named "visible" to you table you will add it to your shema.xml and get this sql :'),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sql"},"DROP TABLE IF EXISTS `block_group`;\n\nCREATE TABLE `block_group`\n(\n    `id` INTEGER NOT NULL AUTO_INCREMENT,\n    `slug` VARCHAR(50),\n    `visible` TINYINT DEFAULT 0 NOT NULL,\n    `created_at` DATETIME,\n    `updated_at` DATETIME,\n    PRIMARY KEY (`id`),\n    UNIQUE INDEX `slug_unique` (`slug`)\n) ENGINE=InnoDB;\n")),(0,i.kt)("p",null,"So you have to extract only the difference like this "),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sql"},"ALTER TABLE `block_group` ADD `visible` TINYINT DEFAULT 0 NOT NULL;\n")),(0,i.kt)("p",null,"Then put this extracted requests on a new file located here ",(0,i.kt)("inlineCode",{parentName:"p"},"local/modules/MyProject/Config/update/")," the name of the file must be the next version of your module for example if the version of your module is ",(0,i.kt)("inlineCode",{parentName:"p"},"1.0.6")," and the next version is ",(0,i.kt)("inlineCode",{parentName:"p"},"1.1.0")," create this file ",(0,i.kt)("inlineCode",{parentName:"p"},"local/modules/MyProject/Config/update/1.1.0.sql")," and put the sql in it and change the ",(0,i.kt)("inlineCode",{parentName:"p"},"<version></version>")," in module.xml.",(0,i.kt)("br",{parentName:"p"}),"\n","Check that you have this function in your base file : "),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-php"},"    /**\n     * Execute sql files in Config/update/ folder named with module version (ex: 1.0.1.sql).\n     *\n     * @param $currentVersion\n     * @param $newVersion\n     * @param ConnectionInterface $con\n     */\n    public function update($currentVersion, $newVersion, ConnectionInterface $con = null): void\n    {\n        $finder = Finder::create()\n            ->name('*.sql')\n            ->depth(0)\n            ->sortByName()\n            ->in(__DIR__.DS.'Config'.DS.'update');\n\n        $database = new Database($con);\n\n        /** @var \\SplFileInfo $file */\n        foreach ($finder as $file) {\n            if (version_compare($currentVersion, $file->getBasename('.sql'), '<')) {\n                $database->insertSql(null, [$file->getPathname()]);\n            }\n        }\n    }\n")),(0,i.kt)("p",null,"if not you will have to add it.\nThis function is called when Thelia refresh module list (either in the admin page oy by command) and detect that the next version of your module is different than the current.\nAnd she will search and execute all sql files between two versions."),(0,i.kt)("h2",{id:"routing"},"Routing"),(0,i.kt)("p",null,"Routing in Thelia work like ",(0,i.kt)("a",{parentName:"p",href:"https://symfony.com/doc/current/routing.html#creating-routes"},"Symfony routing"),".\nA specificity in Thelia is that there is 2 types of Controller :"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Front controllers which extends ",(0,i.kt)("inlineCode",{parentName:"li"},"BaseFrontController")," and when you call a render in it Thelia will search template in frontOffice directory"),(0,i.kt)("li",{parentName:"ul"},"Admin controllers which extend ",(0,i.kt)("inlineCode",{parentName:"li"},"BaseAdminController"),"  when you call a render in it Thelia will search template in backOffice directory, and all routes in these controllers are automatically secured and only logged admins can call them. ")),(0,i.kt)("h2",{id:"templating"},"Templating"),(0,i.kt)("p",null,"The template engine used in Thelia is ",(0,i.kt)("a",{parentName:"p",href:"https://smarty-php.github.io/smarty/"},"Smarty"),".\nThere is 4 types of templates :"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"frontOffice : for templates rendered from a controller that extent ",(0,i.kt)("inlineCode",{parentName:"li"},"BaseFrontController")),(0,i.kt)("li",{parentName:"ul"},"backOffice : for templates rendered from a controller that extent ",(0,i.kt)("inlineCode",{parentName:"li"},"BaseAdminController")),(0,i.kt)("li",{parentName:"ul"},"pdf : for pdf documents like invoices"),(0,i.kt)("li",{parentName:"ul"},"mail : for mail sent by Thelia")),(0,i.kt)("p",null,"For each of this types you can choose an active template. Either by the configuration page in back office or by these environment variables: "),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"ACTIVE_FRONT_TEMPLATE    \nACTIVE_ADMIN_TEMPLATE    \nACTIVE_MAIL_TEMPLATE   \nACTIVE_PDF_TEMPLATE   \n")),(0,i.kt)("div",{className:"admonition admonition-caution alert alert--warning"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 16 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"}))),"caution")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"We advised to never modify the defaults templates but copy and rename it with the name of your project.",(0,i.kt)("br",{parentName:"p"}),"\n","Like this you can always update Thelia and the defaults templates without loosing your changes"))),(0,i.kt)("h3",{id:"templates-structure"},"Templates structure"),(0,i.kt)("p",null,"Thelia Smarty templates are located in the templates sub-directory."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"\\templates\n  \\frontOffice\n    \\default\n    \\myTemplate\n  \\backOffice\n    \\default\n    ...  \n  \\pdf\n    \\default\n    ...  \n  \\mail\n    \\default\n    ...\n")),(0,i.kt)("p",null,"This is the structure of all Thelia templates, it can be located either at the root of your project or in each module folder.\nIf same file are in multiple templates location Thelia apply this priority to know which as to be rendered (the first file found is the file rendered)"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"In the active template in root templates directory"),(0,i.kt)("li",{parentName:"ol"},"In the active template in each module subdirectory located in root templates directory"),(0,i.kt)("li",{parentName:"ol"},"In the active template in each module templates directory"),(0,i.kt)("li",{parentName:"ol"},"In the default template in root templates directory"),(0,i.kt)("li",{parentName:"ol"},"In the default template in each module subdirectory located in root templates directory"),(0,i.kt)("li",{parentName:"ol"},"In the default template in each module templates directory")),(0,i.kt)("p",null,"For example if you have this structure :"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"\\local\n    \\modules\n        \\MyProject\n            \\templates\n                \\frontOffice\n                    \\default\n                        template.html\n\\templates\n  \\frontOffice\n    \\default\n        template.html\n    \\myTemplate\n        template.html\n        \\modules\n            \\myproject\n                template.html\n")),(0,i.kt)("p",null,"It will check all these directories in this order :"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"\\templates\\frontOffice\\myTemplate\\")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"\\templates\\frontOffice\\myTemplate\\modules\\myproject")," * this for each activated modules"),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"\\local\\modules\\MyProject\\templates\\frontOffice\\myTemplate")," * this for each activated modules"),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"\\templates\\frontOffice\\default\\")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"\\templates\\frontOffice\\default\\modules\\myproject")," * this for each activated modules"),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"\\local\\modules\\MyProject\\templates\\frontOffice\\default")," * this for each activated modules")),(0,i.kt)("h3",{id:"features"},"Features"),(0,i.kt)("h4",{id:"loops"},"Loops"),(0,i.kt)("p",null,"Loops allow to get data from your shop back-end and display them in your front view. More documentation can be found ",(0,i.kt)("a",{parentName:"p",href:"../loops"},"here"),"."),(0,i.kt)("h4",{id:"smarty-plugins"},"Smarty plugins"),(0,i.kt)("p",null,"Smarty plugins are used to execute some function from templates"))}p.isMDXComponent=!0}}]);